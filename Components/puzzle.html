<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <!-- 載入Vue框架 -->
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <!-- 引用Bootstrap CSS Style -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <!-- 引用FontAwesome -->
    <script src="https://kit.fontawesome.com/aaacc8f3a5.js" crossorigin="anonymous"></script>
    <style>
        .answer,
        .puzzleGame {
            width: 50vw;
        }

        .answer img {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="input d-flex flex-nowrap justify-content-center">
            <input type="number" min="3" name="xCount" id="xCount" v-model="xCount">X
            <input type="number" min="3" name="yCount" id="yCount" v-model="yCount">
        </div>
        <div class="puzzleArea text-center d-flex justify-content-center">
            <div class="answer">
                <img id="answerImg" src="..\Images\puzzle.webp" alt="參考答案">
            </div>
            <div class="puzzleGame">
                <template v-for="row in yCount">
                    <div class="rowLine d-flex">
                        <template v-for="col in xCount">
                            <div @click="clickPuzzle(col,row)" class="colLine" :class="'x'+col+'y'+row"
                                :id=`x${col}y${row}`>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>
</body>
<!-- 引用Boostrap Script -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"
    integrity="sha384-eMNCOe7tC1doHpGoWe/6oMVemdAVTMs2xqW4mwXrXsW0L84Iytr2wi5v2QjrP/xp"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"
    integrity="sha384-cn7l7gDp0eyniUwwAZgrzD06kc/tftFf19TOAs2zVinnD/C7E91j9yyk5//jjpt/"
    crossorigin="anonymous"></script>
<script>
    var head = document.head;
    var styleElements = document.createElement('style');
    var app = new Vue({
        //載入位置
        el: '#app',
        //資料
        data: {
            answerImg: document.querySelector('#answerImg'),//參考圖片
            imgWidth: 0,//圖片寬度
            imgHeigth: 0,//圖片高度
            xCount: 3,//橫向幾塊
            yCount: 3,//直向幾塊
            puzzlePeaceWidth: 0,//一格寬度
            puzzlePeaceHeight: 0,//一格高度
            moveEnable: false,//是否可移動
            correctPosition: [],//正確排列順序
            puzzlePosition: [],//現在拼圖排列
            puzzleWhitePos: {
                x: 0,
                y: 0
            }//白色拼圖位置
        },
        //方法
        methods: {
            //取得拼圖區塊長寬
            getPuzzleImageSize() {
                this.answerImg = document.querySelector('#answerImg');
                this.imgWidth = this.answerImg.width
                this.imgHeigth = this.answerImg.height
                this.puzzlePeaceWidth = this.imgWidth / this.xCount
                this.puzzlePeaceHeight = this.imgHeigth / this.yCount
                this.setCSS();
                this.setCorrectData();
            },
            //設定拼圖區塊樣式
            setCSS() {
                this.puzzleWhitePos.x = this.xCount - 1
                this.puzzleWhitePos.y = this.yCount - 1
                styleElements.innerHTML = ''
                for (let y = 1; y <= this.yCount; y++) {
                    for (let x = 1; x <= this.xCount; x++) {
                        if (y == this.yCount && x == this.xCount) {
                            styleElements.innerHTML += `.x${x}y${y}{
                                width:${this.puzzlePeaceWidth}px; 
                                height:${this.puzzlePeaceHeight}px; 
                                margin: 0.5px;
                            }`
                        } else {
                            styleElements.innerHTML += `.x${x}y${y}{
                                background-image: url('../Images/puzzle.webp');
                                margin: 0.5px;
                                background-Size:${this.answerImg.width}px ${this.answerImg.height}px;
                                background-repeat:no-repeat; 
                                width:${this.puzzlePeaceWidth}px; 
                                height:${this.puzzlePeaceHeight}px; 
                                background-Position:-${(x - 1) * this.puzzlePeaceWidth}px -${(y - 1) * this.puzzlePeaceHeight}px
                            }`
                        }
                    }
                }
            },
            // 設定正確拼圖順序的陣列
            setCorrectData() {
                let rowTemp = new Array();
                for (let y = 1; y <= this.yCount; y++) {
                    let colTemp = new Array();
                    for (let x = 1; x <= this.xCount; x++) {
                        colTemp.push(`x${x}y${y}`)
                    }
                    rowTemp.push(colTemp)
                }
                this.correctPosition = rowTemp
                this.puzzlePosition = JSON.parse(JSON.stringify(this.correctPosition))
            },
            //觸發點擊事件
            clickPuzzle(x, y) {
                this.checkMove(x - 1, y - 1)
                if (this.checkWin()) alert('win')
            },
            //檢查點擊是否可移動
            checkMove(x, y) {
                //y軸相減為1且x軸相減為0代表在正上方或正下方, 可以交換
                if (Math.abs(this.puzzleWhitePos.y - y) == 1 && this.puzzleWhitePos.x - x == 0) {
                    this.movingPuzzle(x, y)
                    return
                }
                //x軸相減為1且y軸相減為0代表在左邊或右邊, 可以交換
                if (Math.abs(this.puzzleWhitePos.x - x) == 1 && this.puzzleWhitePos.y - y == 0) {
                    this.movingPuzzle(x, y)
                }
            },
            //移動拼圖
            movingPuzzle(x, y) {
                //用class名稱去抓取白色區塊
                let white = document.querySelector(`.x${this.xCount}y${this.yCount}`)
                //用id去抓取點擊位置的區塊(className會交換, id是固定的)
                let change = document.querySelector(`#x${x + 1}y${y + 1}`)

                white.classList.remove(white.classList[1])
                white.classList.add(`${this.puzzlePosition[y][x]}`)
                change.classList.remove(change.classList[1])
                change.classList.add(`x${this.xCount}y${this.yCount}`)

                let temp = this.puzzlePosition[y][x]
                //紀錄最新的拼圖className位置, 方便撈取替換
                this.puzzlePosition[y][x] = this.puzzlePosition[this.puzzleWhitePos.y][this.puzzleWhitePos.x]
                this.puzzlePosition[this.puzzleWhitePos.y][this.puzzleWhitePos.x] = temp

                //紀錄現在白色區塊位置
                this.puzzleWhitePos.x = x
                this.puzzleWhitePos.y = y
            },
            //檢查是否拚完, 利用正確的陣列跟當前拼圖陣列比對
            checkWin() {
                let result = true

                for (let y = 0; y < this.yCount; y++) {
                    for (let x = 0; x < this.xCount; x++) {
                        if (this.puzzlePosition[y][x] != this.correctPosition[y][x]) {
                            result = false
                        }
                    }
                }

                return result
            }
        },
        //運算
        computed: {
        },
        //監聽
        watch: {
            xCount: function (value) {
                this.xCount = parseInt(value)
                this.getPuzzleImageSize()
            },
            yCount: function (value) {
                this.yCount = Number(value)
                this.getPuzzleImageSize()

            }

        },
        created() {

        },
        mounted() {
            this.answerImg = document.querySelector('#answerImg');
            this.imgWidth = this.answerImg.width
            this.imgHeigth = this.answerImg.height
            this.puzzlePeaceWidth = this.imgWidth / this.xCount
            this.puzzlePeaceHeight = this.imgHeigth / this.yCount
            this.setCSS()
            this.setCorrectData();
            this.puzzlePosition = JSON.parse(JSON.stringify(this.correctPosition))
            head.append(styleElements)

            window.onresize = () => {
                this.getPuzzleImageSize();
            }



        }
    })
</script>

</html>